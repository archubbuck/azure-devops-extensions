name: CD - Publish Extension

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read

jobs:
  publish-extension:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for accurate commit count
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build extension
        run: npm run build
      
      - name: Install TFX CLI
        run: npm install -g tfx-cli
      
      - name: Verify build output
        run: |
          if [ ! -d "apps/notification-hub/dist" ] || [ -z "$(ls -A apps/notification-hub/dist)" ]; then
            echo "âŒ Build verification failed: dist folder is missing or empty."
            exit 1
          fi
          echo "âœ… Build output verified successfully"
          echo ""
          echo "ðŸ“¦ Build artifacts:"
          ls -lh apps/notification-hub/dist/
          if [ -d "apps/notification-hub/dist/assets" ]; then
            echo ""
            echo "ðŸ“ Assets folder:"
            ls -lh apps/notification-hub/dist/assets/
          fi
      
      - name: Update version automatically
        run: |
          echo "Automatically updating version based on git history..."
          node scripts/update-version.mjs
          # Note: jq is pre-installed on GitHub Actions ubuntu-latest runners
          echo "Updated version: $(cat azure-devops-extension.json | jq -r '.version')"
      
      - name: Package and Publish to Azure DevOps
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          PUBLISHER_ID: ${{ secrets.PUBLISHER_ID }}
          ORGANIZATION_NAME: archubbuck
        run: |
          # Update publisher in manifest if PUBLISHER_ID is provided
          if [ -n "$PUBLISHER_ID" ]; then
            echo "Updating publisher ID to $PUBLISHER_ID"
            # Create temp file with updated publisher
            cat azure-devops-extension.json | \
              jq --arg publisher "$PUBLISHER_ID" '.publisher = $publisher' > azure-devops-extension.tmp.json
            mv azure-devops-extension.tmp.json azure-devops-extension.json
          fi
          
          # Check if AZURE_DEVOPS_PAT is set and not empty
          if [ -n "$AZURE_DEVOPS_PAT" ]; then
            echo "Publishing extension to marketplace and sharing with $ORGANIZATION_NAME"
            
            # Use tfx extension publish with retry logic to handle transient timeout errors
            MAX_RETRIES=3
            RETRY_DELAY=30
            ATTEMPT=1
            
            while [ $ATTEMPT -le $MAX_RETRIES ]; do
              echo "ðŸ“¤ Publish attempt $ATTEMPT of $MAX_RETRIES..."
              
              if tfx extension publish \
                --manifest-globs azure-devops-extension.json \
                --share-with $ORGANIZATION_NAME \
                --token $AZURE_DEVOPS_PAT \
                --output-path ./output \
                --no-prompt; then
                echo "âœ… Extension published successfully!"
                break
              else
                EXIT_CODE=$?
                if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Publish attempt $ATTEMPT failed with exit code $EXIT_CODE"
                  echo "â³ Waiting $RETRY_DELAY seconds before retry..."
                  sleep $RETRY_DELAY
                  ATTEMPT=$((ATTEMPT + 1))
                else
                  echo "âŒ All $MAX_RETRIES publish attempts failed"
                  exit $EXIT_CODE
                fi
              fi
            done
          else
            echo "Warning: AZURE_DEVOPS_PAT not set. Creating package only."
            echo "Extension package will be created but not published."
            # Create package only when PAT is not available
            tfx extension create --manifest-globs azure-devops-extension.json --output-path ./output
          fi
      
      - name: Upload VSIX artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extension-package
          path: output/*.vsix
          retention-days: 30
      
      - name: Create release info
        if: always()
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          ORGANIZATION_NAME: archubbuck
        run: |
          echo "Extension built and packaged successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Details" >> $GITHUB_STEP_SUMMARY
          echo "- Organization: archubbuck" >> $GITHUB_STEP_SUMMARY
          echo "- Version: $(cat azure-devops-extension.json | jq -r '.version')" >> $GITHUB_STEP_SUMMARY
          echo "- Extension ID: $(cat azure-devops-extension.json | jq -r '.id')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$AZURE_DEVOPS_PAT" ]; then
            echo "âœ… Extension published to marketplace" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Install at: https://dev.azure.com/$ORGANIZATION_NAME/_settings/extensions" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Extension package created but not published (PAT not configured)" >> $GITHUB_STEP_SUMMARY
          fi
