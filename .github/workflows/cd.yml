name: CD - Publish Extension

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish-extension:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build extensions
        run: npm run build
      
      - name: Install TFX CLI
        run: npm install -g tfx-cli@0.17.0
      
      - name: Verify build output
        run: |
          for app in better-notification-hub better-hello-azure; do
            if [ ! -d "apps/$app/dist" ] || [ -z "$(ls -A apps/$app/dist)" ]; then
              echo "‚ùå Build failed: apps/$app/dist is missing or empty"
              exit 1
            fi
            echo "‚úÖ $app build verified"
          done
      
      - name: Update versions
        env:
          FORCE_VERSION_UPDATE: 'true'
        run: node scripts/update-version.mjs
      
      - name: Commit version updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add azure-devops-extension-*.json .version-counter
            git commit -m "chore: bump extension versions [skip ci]"
            
            # Push with retry on failure
            if ! git push; then
              echo "‚ùå Failed to push version updates (may be due to concurrent workflow)"
              echo "   This could happen if multiple workflows are running simultaneously"
              exit 1
            fi
            echo "‚úÖ Version updates committed"
          else
            echo "‚ÑπÔ∏è No version changes to commit"
          fi
      
      - name: Update publisher in manifests
        if: ${{ secrets.PUBLISHER_ID != '' }}
        env:
          PUBLISHER_ID: ${{ secrets.PUBLISHER_ID }}
        run: |
          echo "Updating publisher ID in manifests..."
          for manifest in azure-devops-extension-*.json; do
            jq --arg pub "$PUBLISHER_ID" '.publisher = $pub' "$manifest" > "$manifest.tmp"
            mv "$manifest.tmp" "$manifest"
            echo "‚úì Updated $manifest"
          done
      
      - name: Package extensions
        run: |
          mkdir -p output
          for manifest in azure-devops-extension-*.json; do
            name=$(jq -r '.name' "$manifest")
            echo "üì¶ Packaging $name..."
            tfx extension create --manifest-globs "$manifest" --output-path ./output
          done
      
      - name: Publish extensions
        if: ${{ secrets.AZURE_DEVOPS_PAT != '' }}
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          ORGANIZATION_NAME: archubbuck
        run: |
          failed=0
          
          for manifest in azure-devops-extension-*.json; do
            name=$(jq -r '.name' "$manifest")
            version=$(jq -r '.version' "$manifest")
            id=$(jq -r '.id' "$manifest")
            
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì§ Publishing: $name v$version"
            echo "   Extension ID: $id"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            # Publish and capture output
            if output=$(tfx extension publish \
              --manifest-globs "$manifest" \
              --share-with "$ORGANIZATION_NAME" \
              --token "$AZURE_DEVOPS_PAT" \
              --output-path ./output \
              --no-prompt 2>&1); then
              echo "‚úÖ Published successfully"
            else
              exit_code=$?
              
              # Check if it's an acceptable error (version conflict or already exists)
              # TFX CLI returns specific error messages for these cases
              if echo "$output" | grep -qiE "(version|VS402962).*must.*increase"; then
                echo "‚ÑπÔ∏è Version already published (not an error)"
              elif echo "$output" | grep -qiE "(extension|VS402904).*already (exists|published)"; then
                echo "‚ÑπÔ∏è Extension already exists (not an error)"
              else
                # Real error - log and count
                echo "‚ùå Publishing failed with exit code $exit_code"
                echo "$output"
                failed=$((failed + 1))
              fi
            fi
            echo ""
          done
          
          if [ $failed -gt 0 ]; then
            echo "‚ùå $failed extension(s) failed to publish"
            exit 1
          fi
          
          echo "‚úÖ All extensions processed successfully"
      
      - name: Upload VSIX artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extension-packages
          path: output/*.vsix
          retention-days: 30
          if-no-files-found: warn
