name: CD - Publish Extension

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read

jobs:
  publish-extension:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for accurate commit count
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build extensions
        run: npm run build
      
      - name: Install TFX CLI
        run: npm install -g tfx-cli
      
      - name: Verify build output
        run: |
          echo "Verifying build output for all extensions..."
          
          # Check notification-hub
          if [ ! -d "apps/notification-hub/dist" ] || [ -z "$(ls -A apps/notification-hub/dist)" ]; then
            echo "âŒ Build verification failed: notification-hub dist folder is missing or empty."
            exit 1
          fi
          echo "âœ… notification-hub build output verified"
          
          # Check hello-azure
          if [ ! -d "apps/hello-azure/dist" ] || [ -z "$(ls -A apps/hello-azure/dist)" ]; then
            echo "âŒ Build verification failed: hello-azure dist folder is missing or empty."
            exit 1
          fi
          echo "âœ… hello-azure build output verified"
          
          echo ""
          echo "ðŸ“¦ Build artifacts:"
          echo ""
          echo "notification-hub:"
          ls -lh apps/notification-hub/dist/
          echo ""
          echo "hello-azure:"
          ls -lh apps/hello-azure/dist/
      
      - name: Update versions automatically
        run: |
          echo "Automatically updating versions for all extensions based on git history..."
          node scripts/update-version.mjs
      
      - name: Package and Publish Extensions to Azure DevOps
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          PUBLISHER_ID: ${{ secrets.PUBLISHER_ID }}
          ORGANIZATION_NAME: archubbuck
        run: |
          # Find all extension manifest files
          MANIFEST_FILES=$(ls azure-devops-extension-*.json)
          
          if [ -z "$MANIFEST_FILES" ]; then
            echo "âŒ No extension manifest files found"
            exit 1
          fi
          
          echo "Found extension manifests:"
          echo "$MANIFEST_FILES"
          echo ""
          
          # Update publisher in all manifests if PUBLISHER_ID is provided
          if [ -n "$PUBLISHER_ID" ]; then
            echo "Updating publisher ID to $PUBLISHER_ID in all manifests..."
            for MANIFEST in $MANIFEST_FILES; do
              cat "$MANIFEST" | \
                jq --arg publisher "$PUBLISHER_ID" '.publisher = $publisher' > "${MANIFEST}.tmp"
              mv "${MANIFEST}.tmp" "$MANIFEST"
              echo "  âœ“ Updated $MANIFEST"
            done
            echo ""
          fi
          
          # Function to publish or package an extension with retry logic
          publish_extension() {
            local MANIFEST=$1
            local EXTENSION_NAME=$(cat "$MANIFEST" | jq -r '.name')
            local EXTENSION_VERSION=$(cat "$MANIFEST" | jq -r '.version')
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ Processing: $EXTENSION_NAME (v$EXTENSION_VERSION)"
            echo "   Manifest: $MANIFEST"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ -n "$AZURE_DEVOPS_PAT" ]; then
              echo "Publishing to marketplace and sharing with $ORGANIZATION_NAME..."
              
              # Use tfx extension publish with retry logic
              MAX_RETRIES=3
              ATTEMPT=1
              
              while [ $ATTEMPT -le $MAX_RETRIES ]; do
                echo "ðŸ“¤ Publish attempt $ATTEMPT of $MAX_RETRIES..."
                
                if tfx extension publish \
                  --manifest-globs "$MANIFEST" \
                  --share-with $ORGANIZATION_NAME \
                  --token $AZURE_DEVOPS_PAT \
                  --output-path ./output \
                  --no-prompt; then
                  echo "âœ… $EXTENSION_NAME published successfully!"
                  return 0
                else
                  EXIT_CODE=$?
                  echo "âš ï¸  Publish attempt $ATTEMPT failed with exit code $EXIT_CODE"
                  
                  if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                    DELAY=$((30 * (2 ** ($ATTEMPT - 1))))
                    echo "â³ Waiting $DELAY seconds before retry..."
                    sleep $DELAY
                    ATTEMPT=$((ATTEMPT + 1))
                  else
                    echo "âŒ All $MAX_RETRIES publish attempts failed for $EXTENSION_NAME"
                    return $EXIT_CODE
                  fi
                fi
              done
            else
              echo "Creating package only (AZURE_DEVOPS_PAT not set)..."
              tfx extension create --manifest-globs "$MANIFEST" --output-path ./output
              echo "âœ… $EXTENSION_NAME package created"
            fi
          }
          
          # Process each extension
          FAILED_EXTENSIONS=""
          SUCCESS_COUNT=0
          
          for MANIFEST in $MANIFEST_FILES; do
            if publish_extension "$MANIFEST"; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              EXTENSION_NAME=$(cat "$MANIFEST" | jq -r '.name')
              FAILED_EXTENSIONS="${FAILED_EXTENSIONS}${EXTENSION_NAME}, "
            fi
            echo ""
          done
          
          # Summary
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Successful: $SUCCESS_COUNT"
          
          if [ -n "$FAILED_EXTENSIONS" ]; then
            echo "âŒ Failed: ${FAILED_EXTENSIONS%, }"
            exit 1
          else
            echo "ðŸŽ‰ All extensions processed successfully!"
          fi
      
      - name: Upload VSIX artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extension-packages
          path: output/*.vsix
          retention-days: 30
      
      - name: Create release info
        if: always()
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          ORGANIZATION_NAME: archubbuck
        run: |
          echo "# Extension Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Published Extensions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List all extension manifests and their details
          MANIFEST_FILES=$(ls azure-devops-extension-*.json)
          for MANIFEST in $MANIFEST_FILES; do
            EXTENSION_NAME=$(cat "$MANIFEST" | jq -r '.name')
            EXTENSION_ID=$(cat "$MANIFEST" | jq -r '.id')
            EXTENSION_VERSION=$(cat "$MANIFEST" | jq -r '.version')
            
            echo "### $EXTENSION_NAME" >> $GITHUB_STEP_SUMMARY
            echo "- **Extension ID**: $EXTENSION_ID" >> $GITHUB_STEP_SUMMARY
            echo "- **Version**: $EXTENSION_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Manifest**: \`$MANIFEST\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$AZURE_DEVOPS_PAT" ]; then
            echo "âœ… Extensions published to Azure DevOps Marketplace" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Install at**: https://dev.azure.com/$ORGANIZATION_NAME/_settings/extensions" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Extension packages created but not published (PAT not configured)" >> $GITHUB_STEP_SUMMARY
          fi
